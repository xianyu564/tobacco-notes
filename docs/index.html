<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tobacco Notes｜烟草笔记</title>
  
  <!-- SEO Meta -->
  <meta name="description" content="轻量、开放的烟草品鉴笔记；一键一句话投稿；浏览最新/全部笔记；支持赞助。" />
  <meta name="keywords" content="烟草,品鉴,笔记,雪茄,纸烟,烟斗,手卷,唇烟,电子烟" />
  <meta name="author" content="Contributors" />
  <meta name="robots" content="index, follow" />
  
  <!-- Open Graph -->
  <meta property="og:title" content="Tobacco Notes｜烟草笔记" />
  <meta property="og:description" content="一句话投稿、轻量浏览、友好索引；为爱发电的烟草品鉴记录与分享。" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://xianyu564.github.io/tobacco-notes/" />
  <meta property="og:image" content="./assets/og-image.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:locale" content="zh_CN" />
  <meta property="og:site_name" content="Tobacco Notes" />
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Tobacco Notes｜烟草笔记" />
  <meta name="twitter:description" content="一句话投稿、轻量浏览、友好索引；为爱发电的烟草品鉴记录与分享。" />
  <meta name="twitter:image" content="./assets/og-image.png" />
  
  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="./assets/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="./assets/favicon-16x16.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="./assets/apple-touch-icon.png" />
  <link rel="manifest" href="./assets/site.webmanifest" />
  <meta name="theme-color" content="#ff4d6d" />
  
  <!-- Styles & Feeds -->
  <link rel="stylesheet" href="./styles.css" />
  <link rel="alternate" type="application/rss+xml" title="RSS Feed" href="./feed.xml" />
  <link rel="alternate" type="application/atom+xml" title="Atom Feed" href="./feed.atom" />
  <link rel="alternate" type="application/json" title="JSON Feed" href="./feed.json" />
  <!-- 核心功能支持 -->
  <script defer src="./js/shortcuts.js"></script>
  <script defer src="./js/theme.js"></script>
  <script defer src="./js/search.js"></script>
  <script defer src="./js/notes.js"></script>
  <script defer src="./js/share.js"></script>
</head>
<body>
  <!-- 固定导航栏 -->
  <nav class="nav">
    <a href="./" class="nav-logo">Tobacco Notes</a>
    <div class="nav-links">
      <button class="btn theme-toggle" aria-label="切换主题">🌓</button>
      <a href="#latest" class="btn">最新笔记</a>
      <a href="#categories" class="btn">分类浏览</a>
      <button class="btn share-button" data-platform="native" aria-label="分享">分享</button>
      <a id="link-one" class="btn primary" href="#">一句话投稿</a>
    </div>
  </nav>

  <header class="site-header">
    <h1>Tobacco Notes｜烟草笔记</h1>
    <p>记录每一次品鉴，分享独特体验</p>
    <div class="cta">
      <a id="link-quick" class="btn primary" href="#">一句话投稿</a>
      <a id="link-form" class="btn" href="#">标准表单</a>
      <a id="link-repo" class="btn" href="#" target="_blank" rel="noopener">在 GitHub 查看</a>
    </div>
  </header>

  <main class="container">
    <section id="latest">
      <h2>
        <span>最新笔记</span>
        <span class="shortcut-hint">⌘K 搜索</span>
      </h2>
      <div class="search">
        <input id="q" type="search" placeholder="搜索标题/分类/作者..." aria-label="搜索笔记" />
        <div class="search-dropdown" hidden></div>
      </div>
      <ul id="latest-list" class="note-list"></ul>
      <div class="list-pagination">
        <button class="btn load-more" hidden>加载更多</button>
      </div>
    </section>

    <section id="categories">
      <h2>按分类浏览</h2>
      <div id="cat-summary" class="cat-summary"></div>
      <div id="by-category" class="categories"></div>
    </section>

    <section id="templates">
      <h2>模板与指引</h2>
      <div class="template-grid">
        <div class="template-card">
          <h3>雪茄｜Cigars</h3>
          <p>适用于：古巴/非古巴雪茄品鉴记录</p>
          <a href="../notes/cigars/TEMPLATE_cigars_bilingual.md" class="btn">查看模板</a>
        </div>
        <div class="template-card">
          <h3>纸烟｜Cigarettes</h3>
          <p>适用于：工业卷烟品鉴记录</p>
          <a href="../notes/cigarettes/TEMPLATE_cigarettes_bilingual.md" class="btn">查看模板</a>
        </div>
        <div class="template-card">
          <h3>烟斗｜Pipe</h3>
          <p>适用于：烟斗草品鉴记录</p>
          <a href="../notes/pipe/TEMPLATE_pipe_bilingual.md" class="btn">查看模板</a>
        </div>
        <div class="template-card">
          <h3>手卷｜RYO</h3>
          <p>适用于：手卷烟品鉴记录</p>
          <a href="../notes/ryo/TEMPLATE_ryo_bilingual.md" class="btn">查看模板</a>
        </div>
        <div class="template-card">
          <h3>唇烟｜Snus</h3>
          <p>适用于：口含烟品鉴记录</p>
          <a href="../notes/snus/TEMPLATE_snus_bilingual.md" class="btn">查看模板</a>
        </div>
        <div class="template-card">
          <h3>电子烟｜E-cig</h3>
          <p>适用于：电子烟品鉴记录</p>
          <a href="../notes/ecig/TEMPLATE_ecig_bilingual.md" class="btn">查看模板</a>
        </div>
      </div>
      <div class="template-links">
        <a href="./contribute.md">参与指南</a>
        <span>·</span>
        <a href="./style-guide.md">写作格式</a>
        <span>·</span>
        <a href="../README.md#how-to-use--使用方式">使用说明</a>
      </div>
    </section>

    <section id="sponsor">
      <h2>赞助支持</h2>
      <p>如果你觉得这个项目有用，欢迎赞助支持。你的支持将用于：</p>
      <ul class="sponsor-uses">
        <li>维护自动化脚本与站点</li>
        <li>改进模板与工具</li>
        <li>社区维护与内容策划</li>
      </ul>
      <div class="sponsors">
        <img src="../.github/WeChat%20Sponsor%20Code.jpg" alt="WeChat 赞助码" />
        <img src="../.github/SG%20PayNow%20Sponsor%20Code.jpg" alt="SG PayNow 赞助码" />
      </div>
      <p class="sponsor-note">
        <a href="./sustainability.md">了解更多关于项目可持续性</a>
      </p>
    </section>
  </main>

  <footer class="site-footer">
    <div class="footer-links">
      <a href="./sustainability.md">为爱发电</a>
      <span>·</span>
      <a href="./contribute.md">如何参与</a>
      <span>·</span>
      <a href="./style-guide.md">写作格式</a>
      <span>·</span>
      <a href="./glossary.md">术语表</a>
      <span>·</span>
      <a href="./contributors.md">贡献者</a>
      <span>·</span>
      <a href="./tasks.md">开放任务</a>
    </div>
    <div class="footer-feeds">
      订阅更新：
      <a href="./feed.xml">RSS</a>
      <span>·</span>
      <a href="./feed.atom">Atom</a>
      <span>·</span>
      <a href="./feed.json">JSON Feed</a>
    </div>
    <small class="footer-meta">
      内容采用 CC BY 4.0 授权；代码采用 MIT 许可证
      <br>
      健康提示：所有形式的烟草使用均有害健康。本站仅用于记录与交流，不鼓励使用。
    </small>
  </footer>

  <script>
    // 核心功能
    async function loadJSON(path) {
      const res = await fetch(path);
      if (!res.ok) return [];
      return await res.json();
    }

    // GitHub 仓库链接处理
    function computeRepoUrls() {
      const parts = (location.pathname || '/').split('/').filter(Boolean);
      let owner = '';
      let repo = '';
      if (parts.length >= 2) {
        owner = parts[0];
        repo = parts[1];
      }
      if (!owner || !repo) return null;
      const base = `https://github.com/${owner}/${repo}`;
      return {
        repo: base,
        one: `${base}/issues/new?template=quick.yml`,
        form: `${base}/issues/new?template=tasting.yml`
      };
    }

    // DOM 辅助函数
    function el(tag, attrs={}, children=[]) {
      const e = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=> e.setAttribute(k, v));
      children.forEach(c=> e.appendChild(typeof c === 'string'? document.createTextNode(c): c));
      return e;
    }

    // 笔记项渲染
    function noteItem(n) {
      const a = el('a', { 
        href: `../${n.path}`,
        target: '_blank',
        rel: 'noopener',
        title: n.title
      }, [n.title]);

      const copyBtn = el('button', {
        class: 'copy',
        'aria-label': '复制链接'
      }, ['复制链接']);

      copyBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        const url = location.origin + '/' + location.pathname.split('/').filter(Boolean).slice(0,2).join('/') + '/' + n.path;
        try {
          await navigator.clipboard.writeText(url);
          copyBtn.textContent = '已复制';
          setTimeout(()=> copyBtn.textContent='复制链接', 1200);
        } catch(e) {
          console.error('Copy failed:', e);
        }
      });

      const author = n.author ? ` @${n.author}` : '';
      
      return el('li', {}, [
        el('span', { class: 'date' }, [n.date + ' ']),
        el('span', { class: 'cat' }, ['['+n.category+'] ']),
        a,
        el('span', { class: 'author'}, [author]),
        copyBtn
      ]);
    }

    // 初始化
    (async () => {
      // 设置仓库链接
      const urls = computeRepoUrls();
      const aOne = document.getElementById('link-one');
      const aQuick = document.getElementById('link-quick');
      const aForm = document.getElementById('link-form');
      const aRepo = document.getElementById('link-repo');
      
      if (urls) {
        [aOne, aQuick].forEach(a => a.href = urls.one);
        aForm.href = urls.form;
        aRepo.href = urls.repo;
      } else {
        [aOne, aQuick].forEach(a => a.href = '../issues/new?template=quick.yml');
        aForm.href = '../issues/new?template=tasting.yml';
        aRepo.href = '../../';
      }

      // 加载数据
      const latest = await loadJSON('./data/latest.json');
      const all = await loadJSON('./data/index.json');
      
      // 渲染最新列表
      const latestList = document.getElementById('latest-list');
      let current = latest.slice();
      
      function renderLatest(list, replace = true) {
        if (replace) {
          latestList.innerHTML = '';
        }
        list.forEach(n => latestList.appendChild(noteItem(n)));
      }
      
      renderLatest(current);

      // 搜索功能
      const input = document.getElementById('q');
      const dropdown = document.querySelector('.search-dropdown');
      
      input.addEventListener('input', () => {
        const v = input.value.trim().toLowerCase();
        if (!v) {
          renderLatest(latest);
          dropdown.hidden = true;
          return;
        }
        
        const filtered = latest.filter(n =>
          (n.title || '').toLowerCase().includes(v) ||
          (n.category || '').toLowerCase().includes(v) ||
          (n.author || '').toLowerCase().includes(v)
        );
        
        renderLatest(filtered);
      });

      // 分类统计
      const catOrder = ['cigars','cigarettes','pipe','ryo','snus','ecig'];
      const counts = Object.fromEntries(catOrder.map(c=>[c,0]));
      all.forEach(n => { if (counts[n.category] !== undefined) counts[n.category]++; });
      
      const catSummary = document.getElementById('cat-summary');
      catSummary.innerHTML = '';
      catOrder.forEach(c => {
        const badge = el('a', {
          class: 'badge',
          href: `#${c}`,
          'data-category': c
        }, [`${c}: ${counts[c]}`]);
        catSummary.appendChild(badge);
      });

      // 分类列表
      const byCat = {};
      all.forEach(n => (byCat[n.category] = byCat[n.category] || []).push(n));
      
      const container = document.getElementById('by-category');
      Object.keys(byCat).forEach(cat => {
        const section = el('div', {
          class: 'category-block',
          id: cat
        }, [
          el('h3', {}, [
            cat,
            el('span', { class: 'count' }, [` (${byCat[cat].length}))`])
          ])
        ]);
        
        const ul = el('ul', { class: 'note-list' });
        byCat[cat].slice(0, 50).forEach(n => ul.appendChild(noteItem(n)));
        
        if (byCat[cat].length > 50) {
          const more = el('button', {
            class: 'btn load-more',
            'data-category': cat
          }, [`加载更多 ${cat} 笔记`]);
          
          more.addEventListener('click', () => {
            const start = ul.children.length;
            const next = byCat[cat].slice(start, start + 50);
            next.forEach(n => ul.appendChild(noteItem(n)));
            if (start + 50 >= byCat[cat].length) {
              more.hidden = true;
            }
          });
          
          section.appendChild(ul);
          section.appendChild(more);
        } else {
          section.appendChild(ul);
        }
        
        container.appendChild(section);
      });
    })();
  </script>
</body>
</html>