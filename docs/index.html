<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tobacco Notes｜烟草笔记</title>
  
  <!-- SEO Meta -->
  <meta name="description" content="轻量、开放的烟草品鉴笔记；一键一句话投稿；浏览最新/全部笔记；支持赞助。" />
  <meta name="keywords" content="烟草,品鉴,笔记,雪茄,纸烟,烟斗,手卷,唇烟,电子烟" />
  <meta name="author" content="Contributors" />
  <meta name="robots" content="index, follow" />
  
  <!-- Open Graph -->
  <meta property="og:title" content="Tobacco Notes｜烟草笔记" />
  <meta property="og:description" content="一句话投稿、轻量浏览、友好索引；为爱发电的烟草品鉴记录与分享。" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://xianyu564.github.io/tobacco-notes/" />
  <meta property="og:image" content="./assets/og-image.png" />
  <meta property="og:image:width" content="1200" />
  <meta property="og:image:height" content="630" />
  <meta property="og:locale" content="zh_CN" />
  <meta property="og:site_name" content="Tobacco Notes" />
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Tobacco Notes｜烟草笔记" />
  <meta name="twitter:description" content="一句话投稿、轻量浏览、友好索引；为爱发电的烟草品鉴记录与分享。" />
  <meta name="twitter:image" content="./assets/og-image.png" />
  
  <!-- Icons -->
  <link rel="icon" type="image/png" sizes="32x32" href="./assets/favicon-32x32.png" />
  <link rel="icon" type="image/png" sizes="16x16" href="./assets/favicon-16x16.png" />
  <link rel="apple-touch-icon" sizes="180x180" href="./assets/apple-touch-icon.png" />
  <link rel="manifest" href="./assets/site.webmanifest" />
  <meta name="theme-color" content="#ff4d6d" />
  
  <!-- Styles & Feeds -->
  <link rel="stylesheet" href="./styles.css" />
  
  <!-- Feed Discovery (Enhanced) -->
  <link rel="alternate" type="application/rss+xml" title="RSS Feed - 烟草笔记最新更新" href="./feed.xml" />
  <link rel="alternate" type="application/atom+xml" title="Atom Feed - 烟草笔记最新更新" href="./feed.atom" />
  <link rel="alternate" type="application/json" title="JSON Feed - 烟草笔记最新更新" href="./feed.json" />
  
  <!-- Feed Icon -->
  <link rel="icon" type="image/svg+xml" href="./assets/feed-icon.svg" sizes="any" />
  
  <!-- Additional SEO Meta Tags -->
  <meta name="application-name" content="Tobacco Notes" />
  <meta name="msapplication-TileColor" content="#ff4d6d" />
  <meta name="msapplication-config" content="./assets/browserconfig.xml" />
  <meta name="format-detection" content="telephone=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Tobacco Notes" />
  
  <!-- Canonical URL -->
  <link rel="canonical" href="https://xianyu564.github.io/tobacco-notes/" />
  
  <!-- Feed-specific Meta Tags -->
  <meta name="feed-version" content="2.0" />
  <meta name="feed-generator" content="Tobacco Notes Feed Generator v2.0" />
  <meta name="syndication-right" content="Open" />
  <meta name="rating" content="General" />
  
  <!-- 资源提示 -->
  <!-- 预加载关键资源 -->
  <link rel="preload" href="./styles.css" as="style">
  <link rel="preload" href="./js/theme.js" as="script">
  <link rel="preload" href="./js/search.js" as="script">
  <link rel="preload" href="./assets/favicon-32x32.png" as="image">
  
  <!-- DNS 预解析和预连接 -->
  <link rel="preconnect" href="https://api.github.com">
  <link rel="preconnect" href="https://raw.githubusercontent.com">
  <link rel="dns-prefetch" href="https://api.github.com">
  <link rel="dns-prefetch" href="https://raw.githubusercontent.com">
  
  <!-- 预获取下一页可能需要的资源 -->
  <link rel="prefetch" href="./data/latest.json">
  <link rel="prefetch" href="./data/index.json">
  
  <!-- 关键CSS内联 -->
  <style>
    /* 最小必要样式，用于首屏渲染 */
    :root {
      --primary-color: #ff4d6d;
      --text-color: #333;
      --bg-color: #fff;
    }
    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      line-height: 1.5;
      color: var(--text-color);
      background: var(--bg-color);
    }
    .nav {
      position: fixed;
      top: 0;
      width: 100%;
      background: var(--bg-color);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      z-index: 100;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 1rem;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --text-color: #fff;
        --bg-color: #1a1a1a;
      }
    }
  </style>
  
  <!-- 异步加载完整样式表 -->
  <link rel="stylesheet" href="./styles.css" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="./styles.css"></noscript>
  
  <!-- 核心脚本 -->
  <script defer src="./js/performance.js"></script>
  <script defer src="./js/theme.js"></script>
  <script defer src="./js/search.js"></script>
  <script defer src="./js/notes.js"></script>
  <script defer src="./js/image-optimization.js"></script>
  <script defer src="./js/sponsor.js"></script>

  <!-- 非关键脚本 -->
  <script defer src="./js/shortcuts.js"></script>
  <script defer src="./js/share.js"></script>
  <script defer src="./js/animations.js"></script>
  <script defer src="./js/mobile.js"></script>
  <script defer src="./js/a11y.js"></script>

  <!-- 结构化数据 (JSON-LD) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "Tobacco Notes｜烟草笔记",
    "description": "轻量、开放的烟草品鉴笔记；一键一句话投稿；浏览最新/全部笔记。",
    "url": "https://xianyu564.github.io/tobacco-notes/",
    "image": "https://xianyu564.github.io/tobacco-notes/assets/og-image.png",
    "author": {
      "@type": "Organization",
      "name": "Contributors",
      "url": "https://xianyu564.github.io/tobacco-notes/contributors.md"
    },
    "publisher": {
      "@type": "Organization", 
      "name": "Tobacco Notes",
      "logo": {
        "@type": "ImageObject",
        "url": "https://xianyu564.github.io/tobacco-notes/assets/og-image.png"
      }
    },
    "mainEntity": {
      "@type": "Blog",
      "name": "Tobacco Notes",
      "description": "专业的烟草品鉴笔记与评测分享平台",
      "inLanguage": "zh-CN",
      "copyrightHolder": {
        "@type": "Organization",
        "name": "Contributors"
      },
      "license": "https://creativecommons.org/licenses/by/4.0/"
    },
    "potentialAction": {
      "@type": "SearchAction",
      "target": "https://xianyu564.github.io/tobacco-notes/?q={search_term_string}",
      "query-input": "required name=search_term_string"
    },
    "sameAs": [
      "https://github.com/xianyu564/tobacco-notes"
    ]
  }
  </script>

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "DataFeed",
    "name": "Tobacco Notes RSS Feed",
    "description": "Latest tobacco tasting notes and reviews",
    "url": "https://xianyu564.github.io/tobacco-notes/feed.xml",
    "dataFeedElement": [
      {
        "@type": "DataFeedItem",
        "name": "RSS Feed",
        "url": "https://xianyu564.github.io/tobacco-notes/feed.xml",
        "encodingFormat": "application/rss+xml"
      },
      {
        "@type": "DataFeedItem", 
        "name": "Atom Feed",
        "url": "https://xianyu564.github.io/tobacco-notes/feed.atom",
        "encodingFormat": "application/atom+xml"
      },
      {
        "@type": "DataFeedItem",
        "name": "JSON Feed", 
        "url": "https://xianyu564.github.io/tobacco-notes/feed.json",
        "encodingFormat": "application/json"
      }
    ]
  }
  </script>
</head>
<body>
  <!-- 固定导航栏 -->
  <nav class="nav" role="navigation" aria-label="主导航">
    <a href="./" class="nav-logo" aria-label="返回首页">Tobacco Notes</a>
    <div class="nav-links">
      <button class="btn theme-toggle" aria-label="切换主题">🌓</button>
      <a href="#latest" class="btn" aria-label="查看最新笔记">最新笔记</a>
      <a href="#categories" class="btn" aria-label="按分类浏览笔记">分类浏览</a>
      <a href="#tags" class="btn" aria-label="按标签浏览笔记">标签聚合</a>
      <button class="btn share-button" data-platform="native" aria-label="分享页面">分享</button>
      <a id="link-one" class="btn primary" href="#" aria-label="快速提交一句话笔记">一句话投稿</a>
    </div>
  </nav>

  <header class="site-header animate">
    <h1>Tobacco Notes｜烟草笔记</h1>
    <p>记录每一次品鉴，分享独特体验</p>
    <div class="cta">
      <a id="link-quick" class="btn primary" href="#">一句话投稿</a>
      <a id="link-form" class="btn" href="#">标准表单</a>
      <a id="link-repo" class="btn" href="#" target="_blank" rel="noopener">在 GitHub 查看</a>
    </div>
  </header>

  <main class="container" role="main" aria-label="主要内容">
    <section 
      id="latest" 
      class="animate" 
      aria-labelledby="latest-title"
      data-lazy-scripts="./js/shortcuts.js,./js/share.js"
    >
      <h2 id="latest-title">
        <span>最新笔记</span>
        <span class="shortcut-hint" aria-label="使用快捷键 Command+K 打开搜索">⌘K 搜索</span>
      </h2>
      <div class="search" role="search">
        <input 
          id="q" 
          type="search" 
          placeholder="搜索标题/分类/作者..." 
          aria-label="搜索笔记"
          aria-expanded="false"
          aria-controls="search-results"
          aria-describedby="search-desc" 
        />
        <div id="search-desc" class="sr-only">输入关键词搜索笔记，使用上下箭头键选择结果，回车键确认</div>
        
        <!-- 搜索筛选器 -->
        <div class="search-filters" aria-label="搜索筛选选项">
          <div class="filter-group">
            <label for="category-filter" class="filter-label">分类：</label>
            <select id="category-filter" class="filter-select" aria-label="按分类筛选">
              <option value="">全部分类</option>
              <option value="cigars">雪茄 (Cigars)</option>
              <option value="cigarettes">纸烟 (Cigarettes)</option>
              <option value="pipe">烟斗 (Pipe)</option>
              <option value="ryo">手卷 (RYO)</option>
              <option value="snus">鼻烟 (Snus)</option>
              <option value="ecig">电子烟 (E-cig)</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="date-filter" class="filter-label">日期：</label>
            <select id="date-filter" class="filter-select" aria-label="按日期筛选">
              <option value="">全部日期</option>
              <option value="week">最近一周</option>
              <option value="month">最近一月</option>
              <option value="3months">最近三月</option>
              <option value="year">最近一年</option>
            </select>
          </div>
          
          <div class="filter-group">
            <label for="rating-filter" class="filter-label">评分：</label>
            <select id="rating-filter" class="filter-select" aria-label="按评分筛选">
              <option value="">全部评分</option>
              <option value="high">高分 (≥4/5 或 ≥80/100)</option>
              <option value="medium">中等 (3-3.9/5 或 60-79/100)</option>
              <option value="low">低分 (<3/5 或 <60/100)</option>
            </select>
          </div>
          
          <button id="clear-filters" class="btn filter-clear" aria-label="清除所有筛选">
            清除筛选
          </button>
        </div>
        
        <div 
          id="search-results"
          class="search-dropdown" 
          role="listbox" 
          aria-label="搜索结果"
          hidden
        ></div>
      </div>
      <ul 
        id="latest-list" 
        class="note-list"
        role="list"
        aria-label="最新笔记列表"
      ></ul>
      <div class="list-pagination">
        <button 
          class="btn load-more" 
          hidden
          aria-label="加载更多笔记"
        >加载更多</button>
      </div>
    </section>

    <section 
      id="categories" 
      class="animate" 
      aria-labelledby="categories-title"
      data-lazy-scripts="./js/animations.js"
    >
      <h2 id="categories-title">按分类浏览</h2>
      <div 
        id="cat-summary" 
        class="cat-summary"
        role="navigation"
        aria-label="分类快速导航"
      ></div>
      <div 
        id="by-category" 
        class="categories"
        role="region"
        aria-label="分类笔记列表"
      ></div>
    </section>

    <section 
      id="tags" 
      class="animate" 
      aria-labelledby="tags-title"
      data-lazy-scripts="./js/tags.js"
    >
      <h2 id="tags-title">标签聚合｜Tag Aggregation</h2>
      <div 
        class="tag-summary"
        role="region"
        aria-label="标签统计信息"
      >
        <div id="tag-stats" class="tag-stats">
          <span class="stat-item">
            <span class="stat-number" id="total-tags">-</span>
            <span class="stat-label">个标签</span>
          </span>
          <span class="stat-item">
            <span class="stat-number" id="tagged-notes">-</span>
            <span class="stat-label">篇笔记</span>
          </span>
        </div>
      </div>

      <div class="tag-sections">
        <!-- Featured tag collections -->
        <div 
          id="featured-tags" 
          class="featured-tags"
          role="region"
          aria-label="精选标签集合"
        >
          <h3>精选标签 | Featured Tags</h3>
          <div id="featured-collections" class="featured-collections">
            <!-- Dynamic content loaded by JS -->
          </div>
        </div>

        <!-- Popular tags cloud -->
        <div 
          id="popular-tags" 
          class="popular-tags"
          role="region"
          aria-label="热门标签云"
        >
          <h3>热门标签 | Popular Tags</h3>
          <div id="tag-cloud" class="tag-cloud">
            <!-- Dynamic content loaded by JS -->
          </div>
        </div>

        <!-- Tag filtering and browsing -->
        <div 
          id="tag-filter" 
          class="tag-filter"
          role="region"
          aria-label="按标签筛选"
        >
          <h3>按标签浏览 | Browse by Tags</h3>
          <div class="tag-filter-controls">
            <input 
              type="text" 
              id="tag-search"
              placeholder="搜索标签..."
              aria-label="搜索标签"
              class="tag-search-input"
            />
            <select 
              id="tag-category-filter"
              aria-label="按分类筛选标签"
              class="tag-category-select"
            >
              <option value="">全部分类</option>
              <option value="cigars">雪茄 (Cigars)</option>
              <option value="cigarettes">纸烟 (Cigarettes)</option>
              <option value="pipe">烟斗 (Pipe)</option>
              <option value="ryo">手卷 (RYO)</option>
              <option value="snus">鼻烟 (Snus)</option>
              <option value="ecig">电子烟 (E-cig)</option>
            </select>
          </div>
          <div id="filtered-tag-results" class="filtered-tag-results">
            <!-- Dynamic content loaded by JS -->
          </div>
        </div>
      </div>
    </section>

    <section 
      id="templates" 
      class="animate" 
      aria-labelledby="templates-title"
      data-lazy-scripts="./js/mobile.js"
    >
      <h2 id="templates-title">模板与指引</h2>
      <div 
        class="template-grid"
        role="list"
        aria-label="笔记模板列表"
      >
        <div class="template-card" role="listitem">
          <h3>雪茄｜Cigars</h3>
          <p>适用于：古巴/非古巴雪茄品鉴记录</p>
          <a 
            href="../notes/cigars/TEMPLATE_cigars_bilingual.md" 
            class="btn"
            aria-label="查看雪茄品鉴记录模板"
          >查看模板</a>
        </div>
        <div class="template-card" role="listitem">
          <h3>纸烟｜Cigarettes</h3>
          <p>适用于：工业卷烟品鉴记录</p>
          <a 
            href="../notes/cigarettes/TEMPLATE_cigarettes_bilingual.md" 
            class="btn"
            aria-label="查看纸烟品鉴记录模板"
          >查看模板</a>
        </div>
        <div class="template-card" role="listitem">
          <h3>烟斗｜Pipe</h3>
          <p>适用于：烟斗草品鉴记录</p>
          <a 
            href="../notes/pipe/TEMPLATE_pipe_bilingual.md" 
            class="btn"
            aria-label="查看烟斗品鉴记录模板"
          >查看模板</a>
        </div>
        <div class="template-card" role="listitem">
          <h3>手卷｜RYO</h3>
          <p>适用于：手卷烟品鉴记录</p>
          <a 
            href="../notes/ryo/TEMPLATE_ryo_bilingual.md" 
            class="btn"
            aria-label="查看手卷烟品鉴记录模板"
          >查看模板</a>
        </div>
        <div class="template-card" role="listitem">
          <h3>唇烟｜Snus</h3>
          <p>适用于：口含烟品鉴记录</p>
          <a 
            href="../notes/snus/TEMPLATE_snus_bilingual.md" 
            class="btn"
            aria-label="查看唇烟品鉴记录模板"
          >查看模板</a>
        </div>
        <div class="template-card" role="listitem">
          <h3>电子烟｜E-cig</h3>
          <p>适用于：电子烟品鉴记录</p>
          <a 
            href="../notes/ecig/TEMPLATE_ecig_bilingual.md" 
            class="btn"
            aria-label="查看电子烟品鉴记录模板"
          >查看模板</a>
        </div>
      </div>
      <div 
        class="template-links"
        role="navigation"
        aria-label="相关文档链接"
      >
        <a href="./contribute.md">参与指南</a>
        <span aria-hidden="true">·</span>
        <a href="./style-guide.md">写作格式</a>
        <span aria-hidden="true">·</span>
        <a href="../README.md#how-to-use--使用方式">使用说明</a>
      </div>
    </section>

    <section 
      id="sponsor" 
      class="animate sponsor-section" 
      aria-labelledby="sponsor-title"
      data-lazy-scripts="./js/a11y.js,./js/sponsor.js"
    >
      <div class="sponsor-container">
        <div class="sponsor-header">
          <h2 id="sponsor-title">❤️ 赞助支持</h2>
          <p class="sponsor-subtitle">如果这个项目对你有帮助，请考虑赞助支持我们的持续发展</p>
        </div>
        
        <div class="sponsor-impact">
          <h3>你的支持将用于：</h3>
          <ul 
            class="sponsor-uses"
            role="list"
            aria-label="赞助用途"
          >
            <li><span class="impact-icon">🔧</span>维护自动化脚本与站点</li>
            <li><span class="impact-icon">📋</span>改进模板与工具</li>
            <li><span class="impact-icon">👥</span>社区维护与内容策划</li>
          </ul>
        </div>

        <div class="sponsor-cta-section">
          <h3>选择你的赞助方式：</h3>
          
          <div class="sponsor-methods">
            <div class="sponsor-method">
              <div class="sponsor-method-header">
                <h4>🔗 GitHub Sponsor</h4>
                <p>官方赞助平台，支持定期赞助</p>
              </div>
              <a 
                href="https://github.com/sponsors/xianyu564" 
                class="btn btn-primary sponsor-btn"
                target="_blank"
                rel="noopener noreferrer"
                aria-label="通过 GitHub Sponsors 赞助项目"
              >
                💖 开始赞助
              </a>
            </div>

            <div class="sponsor-method">
              <div class="sponsor-method-header">
                <h4>📱 扫码赞助</h4>
                <p>微信或新加坡 PayNow 一次性赞助</p>
              </div>
              <button 
                class="btn btn-secondary sponsor-btn toggle-qr"
                aria-label="显示二维码"
                data-target="sponsor-qr-codes"
              >
                📱 显示二维码
              </button>
            </div>
          </div>

          <div 
            id="sponsor-qr-codes"
            class="sponsors-qr hidden"
            role="region"
            aria-label="赞助二维码"
            aria-hidden="true"
          >
            <div class="qr-grid">
              <div class="qr-item">
                <img 
                  src="../.github/WeChat%20Sponsor%20Code.jpg" 
                  alt="微信赞助二维码" 
                  loading="lazy"
                  width="200"
                  height="200"
                />
                <span class="qr-label">微信支付</span>
              </div>
              <div class="qr-item">
                <img 
                  src="../.github/SG%20PayNow%20Sponsor%20Code.jpg" 
                  alt="新加坡 PayNow 赞助二维码" 
                  loading="lazy"
                  width="200"
                  height="200"
                />
                <span class="qr-label">PayNow (SG)</span>
              </div>
            </div>
          </div>
        </div>

        <div class="sponsor-footer">
          <p class="sponsor-note">
            <a 
              href="./sustainability.md"
              aria-label="了解更多关于项目可持续性发展计划"
            >了解更多关于项目可持续性发展 →</a>
          </p>
          <div class="sponsor-thanks">
            <small>感谢每一位赞助者的支持！🙏</small>
          </div>
        </div>
      </div>
    </section>

    <section 
      id="contributors-preview"
      class="animate"
      aria-labelledby="contributors-preview-title"
      data-lazy-scripts="./js/contributors.js"
    >
      <h2 id="contributors-preview-title">👥 贡献者</h2>
      <div id="contributors-widget" aria-live="polite">
        <div class="loading-placeholder">
          <p>正在加载贡献者信息...</p>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer" role="contentinfo">
    <div 
      class="footer-links"
      role="navigation"
      aria-label="页脚导航"
    >
      <a href="./sustainability.md" aria-label="了解项目为爱发电的理念">为爱发电</a>
      <span aria-hidden="true">·</span>
      <a href="./contribute.md" aria-label="了解如何参与项目">如何参与</a>
      <span aria-hidden="true">·</span>
      <a href="./style-guide.md" aria-label="查看笔记写作格式指南">写作格式</a>
      <span aria-hidden="true">·</span>
      <a href="./glossary.md" aria-label="查看术语表">术语表</a>
      <span aria-hidden="true">·</span>
      <a href="./contributors.html" aria-label="查看项目贡献者列表">贡献者</a>
      <span aria-hidden="true">·</span>
      <a href="./tasks.md" aria-label="查看开放任务列表">开放任务</a>
    </div>
    <div 
      class="footer-feeds"
      role="navigation"
      aria-label="订阅源"
    >
      <span>📡 订阅更新：</span>
      <a href="./feed.xml" type="application/rss+xml" aria-label="RSS 订阅 - 最新烟草笔记更新" title="RSS 2.0 订阅源">
        <img src="./assets/feed-icon.svg" alt="RSS" width="16" height="16" style="vertical-align: middle; margin-right: 4px;">
        RSS
      </a>
      <span aria-hidden="true">·</span>
      <a href="./feed.atom" type="application/atom+xml" aria-label="Atom 订阅 - 最新烟草笔记更新" title="Atom 1.0 订阅源">
        <img src="./assets/feed-icon.svg" alt="Atom" width="16" height="16" style="vertical-align: middle; margin-right: 4px;">
        Atom
      </a>
      <span aria-hidden="true">·</span>
      <a href="./feed.json" type="application/json" aria-label="JSON Feed 订阅 - 最新烟草笔记更新" title="JSON Feed 1.1 订阅源">
        <img src="./assets/feed-icon.svg" alt="JSON" width="16" height="16" style="vertical-align: middle; margin-right: 4px;">
        JSON Feed
      </a>
    </div>
    <small 
      class="footer-meta"
      role="contentinfo"
      aria-label="版权和健康提示"
    >
      内容采用 CC BY 4.0 授权；代码采用 MIT 许可证
      <br>
      <strong>健康提示：</strong>所有形式的烟草使用均有害健康。本站仅用于记录与交流，不鼓励使用。
    </small>
  </footer>

  <script>
    // 核心功能
    async function loadJSON(path) {
      const res = await fetch(path);
      if (!res.ok) return [];
      return await res.json();
    }

    // GitHub 仓库链接处理
    function computeRepoUrls() {
      const parts = (location.pathname || '/').split('/').filter(Boolean);
      let owner = '';
      let repo = '';
      if (parts.length >= 2) {
        owner = parts[0];
        repo = parts[1];
      }
      if (!owner || !repo) return null;
      const base = `https://github.com/${owner}/${repo}`;
      return {
        repo: base,
        one: `${base}/issues/new?template=quick.yml`,
        form: `${base}/issues/new?template=tasting.yml`
      };
    }

    // DOM 辅助函数
    function el(tag, attrs={}, children=[]) {
      const e = document.createElement(tag);
      Object.entries(attrs).forEach(([k,v])=> e.setAttribute(k, v));
      children.forEach(c=> e.appendChild(typeof c === 'string'? document.createTextNode(c): c));
      return e;
    }

    // 笔记项渲染
    function noteItem(n) {
      const a = el('a', { 
        href: `../${n.path}`,
        target: '_blank',
        rel: 'noopener',
        title: n.title
      }, [n.title]);

      const copyBtn = el('button', {
        class: 'copy',
        'aria-label': '复制链接'
      }, ['复制链接']);

      copyBtn.addEventListener('click', async (e) => {
        e.preventDefault();
        const url = location.origin + '/' + location.pathname.split('/').filter(Boolean).slice(0,2).join('/') + '/' + n.path;
        try {
          await navigator.clipboard.writeText(url);
          copyBtn.textContent = '已复制';
          setTimeout(()=> copyBtn.textContent='复制链接', 1200);
        } catch(e) {
          console.error('Copy failed:', e);
        }
      });

      const author = n.author ? ` @${n.author}` : '';
      
      return el('li', {}, [
        el('span', { class: 'date' }, [n.date + ' ']),
        el('span', { class: 'cat' }, ['['+n.category+'] ']),
        a,
        el('span', { class: 'author'}, [author]),
        copyBtn
      ]);
    }

    // 初始化
    (async () => {
      // 设置仓库链接
      const urls = computeRepoUrls();
      const aOne = document.getElementById('link-one');
      const aQuick = document.getElementById('link-quick');
      const aForm = document.getElementById('link-form');
      const aRepo = document.getElementById('link-repo');
      
      if (urls) {
        [aOne, aQuick].forEach(a => a.href = urls.one);
        aForm.href = urls.form;
        aRepo.href = urls.repo;
      } else {
        [aOne, aQuick].forEach(a => a.href = '../issues/new?template=quick.yml');
        aForm.href = '../issues/new?template=tasting.yml';
        aRepo.href = '../../';
      }

      // 加载数据
      const latest = await loadJSON('./data/latest.json');
      const all = await loadJSON('./data/index.json');
      
      // 渲染最新列表
      const latestList = document.getElementById('latest-list');
      let current = latest.slice();
      
      function renderLatest(list, replace = true) {
        if (replace) {
          latestList.innerHTML = '';
        }
        list.forEach(n => latestList.appendChild(noteItem(n)));
      }
      
      renderLatest(current);

      // 搜索功能
      const input = document.getElementById('q');
      const dropdown = document.querySelector('.search-dropdown');
      
      input.addEventListener('input', () => {
        const v = input.value.trim().toLowerCase();
        if (!v) {
          renderLatest(latest);
          dropdown.hidden = true;
          return;
        }
        
        const filtered = latest.filter(n =>
          (n.title || '').toLowerCase().includes(v) ||
          (n.category || '').toLowerCase().includes(v) ||
          (n.author || '').toLowerCase().includes(v)
        );
        
        renderLatest(filtered);
      });

      // 分类统计
      const catOrder = ['cigars','cigarettes','pipe','ryo','snus','ecig'];
      const counts = Object.fromEntries(catOrder.map(c=>[c,0]));
      all.forEach(n => { if (counts[n.category] !== undefined) counts[n.category]++; });
      
      const catSummary = document.getElementById('cat-summary');
      catSummary.innerHTML = '';
      catOrder.forEach(c => {
        const badge = el('a', {
          class: 'badge',
          href: `#${c}`,
          'data-category': c
        }, [`${c}: ${counts[c]}`]);
        catSummary.appendChild(badge);
      });

      // 分类列表
      const byCat = {};
      all.forEach(n => (byCat[n.category] = byCat[n.category] || []).push(n));
      
      const container = document.getElementById('by-category');
      Object.keys(byCat).forEach(cat => {
        const section = el('div', {
          class: 'category-block animate',
          id: cat
        }, [
          el('h3', {}, [
            cat,
            el('span', { class: 'count' }, [` (${byCat[cat].length})`])
          ])
        ]);
        
        const ul = el('ul', { class: 'note-list' });
        byCat[cat].slice(0, 50).forEach(n => ul.appendChild(noteItem(n)));
        
        if (byCat[cat].length > 50) {
          const more = el('button', {
            class: 'btn load-more',
            'data-category': cat
          }, [`加载更多 ${cat} 笔记`]);
          
          more.addEventListener('click', () => {
            const start = ul.children.length;
            const next = byCat[cat].slice(start, start + 50);
            next.forEach(n => ul.appendChild(noteItem(n)));
            if (start + 50 >= byCat[cat].length) {
              more.hidden = true;
            }
          });
          
          section.appendChild(ul);
          section.appendChild(more);
        } else {
          section.appendChild(ul);
        }
        
        container.appendChild(section);
      });
    })();
  </script>
</body>
</html>